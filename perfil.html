---
layout: default
title: Perfil
---

<section class="container my-5">
  <h1 class="mb-4 text-center" style="color: var(--verde-escuro);">O Meu Perfil</h1>

  <!-- üîπ Login -->
  <div id="noUser" class="text-center" style="display:block;">
    <p>N√£o est√°s autenticado.</p>
    <button id="loginBtn" class="btn btn-success">Entrar com Google</button>
  </div>

  <!-- üîπ Info utilizador -->
  <div id="userInfo" class="text-center" style="display:none;">
    <img id="userPhoto" src="" alt="Foto de Perfil" class="rounded-circle mb-3" width="120">
    <h3 id="userName"></h3>
    <p id="userEmail"></p>
    <button id="logoutBtn" class="btn btn-danger">Sair</button>
  </div>

  <!-- üîπ Formul√°rio de registo (s√≥ aparece se estiver autorizado) -->
  <div id="registoTreino" style="display:none;" class="mt-5">
    <h2 class="mb-3">Registo de Treino</h2>
    <form id="treinoForm">
      <div class="mb-3">
        <label for="data" class="form-label">Data</label>
        <input type="date" class="form-control" id="data" required>
      </div>
      <div class="mb-3">
        <label for="numFlechas" class="form-label">N√∫mero de Flechas</label>
        <input type="number" class="form-control" id="numFlechas" min="0" required>
      </div>
      <div class="mb-3">
        <label for="observacoes" class="form-label">Observa√ß√µes</label>
        <textarea class="form-control" id="observacoes" rows="3"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Guardar</button>
    </form>

    <hr class="my-4">

    <h3 class="mb-3">Registos Anteriores</h3>
    <div class="table-responsive">
      <table class="table table-striped" id="registosTable">
        <thead class="table-dark">
          <tr>
            <th>Data</th>
            <th>Flechas</th>
            <th>Observa√ß√µes</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <!-- Registos v√£o ser inseridos aqui -->
        </tbody>
      </table>
    </div>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, updateDoc, doc, deleteDoc, orderBy, getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// üîπ Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDxTP9oTiAlDRpjGgC_hL06uzpYLrbzZd8",
  authDomain: "ctap-registo.firebaseapp.com",
  projectId: "ctap-registo",
  storageBucket: "ctap-registo.appspot.com",
  messagingSenderId: "460997897512",
  appId: "1:460997897512:web:841860bf674a5b1d19b41d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userInfoDiv = document.getElementById("userInfo");
const noUserDiv = document.getElementById("noUser");
const registoDiv = document.getElementById("registoTreino");

const userPhoto = document.getElementById("userPhoto");
const userName = document.getElementById("userName");
const userEmail = document.getElementById("userEmail");
const registosTableBody = document.querySelector("#registosTable tbody");

let currentUser = null;

// üîπ Estado de autentica√ß√£o
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;

    // Verificar se o email do utilizador est√° na lista de emails autorizados
    const configDoc = doc(db, "config", "autorizados");
    const configSnap = await getDoc(configDoc);

    if (!configSnap.exists()) {
      alert("Configura√ß√£o de emails autorizados n√£o encontrada!");
      currentUser = null;
      noUserDiv.style.display = "block";
      loginBtn.style.display = "inline-block";
      return;
    }

    const emailsAutorizados = configSnap.data().emails || [];

    if (!emailsAutorizados.includes(user.email)) {
      alert("N√£o tens permiss√£o para aceder a este site.");
      currentUser = null;
      userInfoDiv.style.display = "none";
      registoDiv.style.display = "none";
      noUserDiv.style.display = "block";
      loginBtn.style.display = "inline-block";
      await signOut(auth);
      return;
    }

    // Email autorizado ‚Äî mostrar info do utilizador e formul√°rio
    userInfoDiv.style.display = "block";
    noUserDiv.style.display = "none";
    registoDiv.style.display = "block";
    loginBtn.style.display = "none";

    userPhoto.src = user.photoURL || "https://via.placeholder.com/120";
    userName.textContent = user.displayName || "Utilizador sem nome";
    userEmail.textContent = user.email;

    carregarRegistos();

  } else {
    currentUser = null;
    userInfoDiv.style.display = "none";
    registoDiv.style.display = "none";
    noUserDiv.style.display = "block";
    loginBtn.style.display = "inline-block";
  }
});

// üîπ Login com Google
loginBtn.addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch (error) {
    console.error("Erro Firebase:", error);
    alert("Erro ao entrar: " + error.message);
  }
});

// üîπ Logout
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  alert("Terminaste a sess√£o.");
});

// üîπ Guardar treino
document.getElementById("treinoForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = document.getElementById("data").value;
  const numFlechas = parseInt(document.getElementById("numFlechas").value);
  const observacoes = document.getElementById("observacoes").value;

  try {
    await addDoc(collection(db, "treinos"), {
      data,
      numFlechas,
      observacoes,
      uid: currentUser.uid,
      email: currentUser.email,
      timestamp: serverTimestamp()
    });
    alert("Treino guardado com sucesso!");
    e.target.reset();
    carregarRegistos();
  } catch (error) {
    console.error("Erro ao guardar treino:", error);
    alert("Erro ao guardar treino.");
  }
});

// üîπ Carregar registos ordenados por data desc
async function carregarRegistos() {
  registosTableBody.innerHTML = "";
  const q = query(
    collection(db, "treinos"),
    where("email", "==", currentUser.email),
    orderBy("data", "desc")
  );
  const snapshot = await getDocs(q);

  snapshot.forEach(docSnap => {
    const registo = docSnap.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="date" value="${registo.data}" class="form-control form-control-sm" id="data-${docSnap.id}" readonly></td>
      <td><input type="number" value="${registo.numFlechas}" class="form-control form-control-sm" id="flechas-${docSnap.id}" readonly></td>
      <td><textarea class="form-control form-control-sm" id="obs-${docSnap.id}" rows="1" readonly>${registo.observacoes || ''}</textarea></td>
      <td>
        <button class="btn btn-primary btn-sm me-1" id="edit-${docSnap.id}">Editar</button>
        <button class="btn btn-danger btn-sm" id="delete-${docSnap.id}">Apagar</button>
      </td>
    `;
    registosTableBody.appendChild(tr);

    const btnEdit = document.getElementById(`edit-${docSnap.id}`);
    const inputData = document.getElementById(`data-${docSnap.id}`);
    const inputFlechas = document.getElementById(`flechas-${docSnap.id}`);
    const inputObs = document.getElementById(`obs-${docSnap.id}`);

    // Apagar registo
    document.getElementById(`delete-${docSnap.id}`).addEventListener("click", async () => {
      if (confirm("Tens a certeza que queres apagar este registo?")) {
        try {
          await deleteDoc(doc(db, "treinos", docSnap.id));
          alert("Registo apagado com sucesso!");
          carregarRegistos();
        } catch (error) {
          console.error("Erro ao apagar registo:", error);
          alert("Erro ao apagar registo.");
        }
      }
    });

    // Editar / Guardar
    btnEdit.addEventListener("click", async () => {
      if (btnEdit.textContent === "Editar") {
        inputData.removeAttribute("readonly");
        inputFlechas.removeAttribute("readonly");
        inputObs.removeAttribute("readonly");
        btnEdit.textContent = "Guardar";
        inputObs.rows = 3;
      } else {
        const novaData = inputData.value;
        const novasFlechas = parseInt(inputFlechas.value);
        const novasObs = inputObs.value;

        try {
          await updateDoc(doc(db, "treinos", docSnap.id), {
            data: novaData,
            numFlechas: novasFlechas,
            observacoes: novasObs
          });
          alert("Registo atualizado com sucesso!");
          inputData.setAttribute("readonly", true);
          inputFlechas.setAttribute("readonly", true);
          inputObs.setAttribute("readonly", true);
          btnEdit.textContent = "Editar";
          inputObs.rows = 1;
        } catch (error) {
          console.error("Erro ao atualizar registo:", error);
          alert("Erro ao atualizar registo.");
        }
      }
    });
  });
}
</script>
