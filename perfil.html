---
layout: default
title: Perfil
---

<section class="container my-5">
  <h1 class="mb-4 text-center" style="color: var(--verde-escuro);">O Meu Perfil</h1>

  <!-- üîπ Login -->
  <div id="noUser" class="text-center" style="display:block;">
    <p>N√£o est√°s autenticado.</p>
    <button id="loginBtn" class="btn btn-success">Entrar com Google</button>
  </div>

  <!-- üîπ Info utilizador -->
  <div id="userInfo" class="text-center" style="display:none;">
    <img id="userPhoto" src="" alt="Foto de Perfil" class="rounded-circle mb-3" width="120">
    <h3 id="userName"></h3>
    <p id="userEmail"></p>
    <button id="logoutBtn" class="btn btn-danger">Sair</button>
  </div>

  <!-- üîπ Formul√°rio de registo (s√≥ atletas) -->
  <div id="registoTreino" style="display:none;" class="mt-5">
    <h2 class="mb-3">Registo de Treino</h2>
    <form id="treinoForm">
      <div class="mb-3">
        <label for="data" class="form-label">Data</label>
        <input type="date" class="form-control" id="data" required>
      </div>
      <div class="mb-3">
        <label for="numFlechas" class="form-label">N√∫mero de Flechas</label>
        <input type="number" class="form-control" id="numFlechas" min="0" required>
      </div>
      <div class="mb-3">
        <label for="observacoes" class="form-label">Observa√ß√µes</label>
        <textarea class="form-control" id="observacoes" rows="3"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Guardar</button>
    </form>
  </div>

  <hr class="my-4">

  <!-- üîπ Registos e exporta√ß√£o -->
  <div class="d-flex justify-content-between mb-3" id="registosHeader" style="display:none;">
    <h3>Registos de Treino</h3>
    <button id="exportBtn" class="btn btn-success">Exportar para Excel</button>
  </div>

  <div class="table-responsive" id="registosContainer" style="display:none;">
    <table class="table table-striped" id="registosTable">
      <thead class="table-dark">
        <tr>
          <th>Atleta</th>
          <th>Data</th>
          <th>Flechas</th>
          <th>Observa√ß√µes</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <!-- Registos v√£o ser inseridos aqui -->
      </tbody>
    </table>
  </div>
</section>

<!-- üîπ SheetJS para exporta√ß√£o Excel -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, updateDoc, doc, deleteDoc, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// üîπ Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDxTP9oTiAlDRpjGgC_hL06uzpYLrbzZd8",
  authDomain: "ctap-registo.firebaseapp.com",
  projectId: "ctap-registo",
  storageBucket: "ctap-registo.appspot.com",
  messagingSenderId: "460997897512",
  appId: "1:460997897512:web:841860bf674a5b1d19b41d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userInfoDiv = document.getElementById("userInfo");
const noUserDiv = document.getElementById("noUser");
const registoDiv = document.getElementById("registoTreino");
const registosTableBody = document.querySelector("#registosTable tbody");
const exportBtn = document.getElementById("exportBtn");
const registosHeader = document.getElementById("registosHeader");
const registosContainer = document.getElementById("registosContainer");

const userPhoto = document.getElementById("userPhoto");
const userName = document.getElementById("userName");
const userEmail = document.getElementById("userEmail");

let currentUser = null;
let isAtleta = false;
let isTreinador = false;
let atletasArray = [];

// üîπ Fun√ß√£o para obter o nome do atleta pelo email
function getNomeAtleta(email) {
  const atleta = atletasArray.find(a => a.email.toLowerCase() === email.toLowerCase());
  return atleta ? atleta.nome : email;
}

// üîπ Estado de autentica√ß√£o
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;

    try {
      const docRef = doc(db, "config", "autorizados");
      const docSnap = await getDoc(docRef);

      const data = docSnap.exists() ? docSnap.data() : {};
      const emailsAutorizados = (data.emails || []).map(e => e.toLowerCase());
      const treinadores = (data.treinadores || []).map(e => e.toLowerCase());
      atletasArray = (data.atletas || []).map(a => ({ nome: a.nome, email: a.email.toLowerCase() }));

      const emailUser = user.email.toLowerCase();

      isAtleta = emailsAutorizados.includes(emailUser);
      isTreinador = treinadores.includes(emailUser);

      if (!isAtleta && !isTreinador) {
        alert("N√£o tens permiss√£o para aceder a este site.");
        currentUser = null;
        return mostrarSoLogin();
      }

      mostrarTudoAutorizado();

    } catch (error) {
      console.error("Erro ao verificar autoriza√ß√£o:", error);
      alert("Erro ao verificar autoriza√ß√£o.");
      currentUser = null;
      mostrarSoLogin();
    }

  } else {
    currentUser = null;
    mostrarSoLogin();
  }
});

// üîπ Fun√ß√£o para mostrar s√≥ login
function mostrarSoLogin() {
  userInfoDiv.style.display = "none";
  registoDiv.style.display = "none";
  registosHeader.style.display = "none";
  registosContainer.style.display = "none";
  noUserDiv.style.display = "block";
  loginBtn.style.display = "inline-block";
}

// üîπ Fun√ß√£o para mostrar tudo ap√≥s login autorizado
function mostrarTudoAutorizado() {
  userInfoDiv.style.display = "block";
  noUserDiv.style.display = "none";
  loginBtn.style.display = "none";

  registoDiv.style.display = isAtleta ? "block" : "none";
  registosHeader.style.display = "flex";
  registosContainer.style.display = "block";

  userPhoto.src = currentUser.photoURL || "https://via.placeholder.com/120";
  userName.textContent = currentUser.displayName || "Utilizador sem nome";
  userEmail.textContent = currentUser.email;

  carregarRegistos();
}

// üîπ Login com Google
loginBtn.addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  try { await signInWithPopup(auth, provider); }
  catch (error) { alert("Erro ao entrar: " + error.message); }
});

// üîπ Logout
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  alert("Terminaste a sess√£o.");
});

// üîπ Guardar treino (apenas atletas)
document.getElementById("treinoForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser || !isAtleta) return;

  const data = document.getElementById("data").value;
  const numFlechas = parseInt(document.getElementById("numFlechas").value);
  const observacoes = document.getElementById("observacoes").value;

  try {
    await addDoc(collection(db, "treinos"), {
      email: currentUser.email,
      data,
      numFlechas,
      observacoes,
      timestamp: serverTimestamp()
    });
    alert("Treino guardado com sucesso!");
    e.target.reset();
    carregarRegistos();
  } catch (error) {
    console.error("Erro ao guardar treino:", error);
    alert("Erro ao guardar treino.");
  }
});

// üîπ Carregar registos
async function carregarRegistos() {
  registosTableBody.innerHTML = "";

  let q;
  if (isTreinador) {
    q = query(collection(db, "treinos"), orderBy("data", "desc"));
  } else {
    q = query(collection(db, "treinos"), where("email", "==", currentUser.email), orderBy("data", "desc"));
  }

  const snapshot = await getDocs(q);

  snapshot.forEach(docSnap => {
    const registo = docSnap.data();
    const tr = document.createElement("tr");

    const nomeAtleta = getNomeAtleta(registo.email);

    tr.innerHTML = `
      <td>${nomeAtleta}</td>
      <td><input type="date" value="${registo.data}" class="form-control form-control-sm" id="data-${docSnap.id}" readonly></td>
      <td><input type="number" value="${registo.numFlechas}" class="form-control form-control-sm" id="flechas-${docSnap.id}" readonly></td>
      <td><textarea class="form-control form-control-sm" id="obs-${docSnap.id}" rows="1" readonly>${registo.observacoes || ''}</textarea></td>
      <td>
        <button class="btn btn-primary btn-sm me-1" id="edit-${docSnap.id}">Editar</button>
        <button class="btn btn-danger btn-sm" id="delete-${docSnap.id}">Apagar</button>
      </td>
    `;
    registosTableBody.appendChild(tr);

    const btnEdit = document.getElementById(`edit-${docSnap.id}`);
    const btnDelete = document.getElementById(`delete-${docSnap.id}`);
    const inputData = document.getElementById(`data-${docSnap.id}`);
    const inputFlechas = document.getElementById(`flechas-${docSnap.id}`);
    const inputObs = document.getElementById(`obs-${docSnap.id}`);

    const emailUser = currentUser.email.toLowerCase();
    const podeEditarApagar = isTreinador || registo.email.toLowerCase() === emailUser;

    btnEdit.style.display = podeEditarApagar ? "inline-block" : "none";
    btnDelete.style.display = podeEditarApagar ? "inline-block" : "none";

    btnDelete.addEventListener("click", async () => {
      if (confirm("Tens a certeza que queres apagar este registo?")) {
        try {
          await deleteDoc(doc(db, "treinos", docSnap.id));
          carregarRegistos();
        } catch (error) { alert("Erro ao apagar registo."); }
      }
    });

    btnEdit.addEventListener("click", async () => {
      if (btnEdit.textContent === "Editar") {
        inputData.removeAttribute("readonly");
        inputFlechas.removeAttribute("readonly");
        inputObs.removeAttribute("readonly");
        btnEdit.textContent = "Guardar";
        inputObs.rows = 3;
      } else {
        try {
          await updateDoc(doc(db, "treinos", docSnap.id), {
            data: inputData.value,
            numFlechas: parseInt(inputFlechas.value),
            observacoes: inputObs.value
          });
          inputData.setAttribute("readonly", true);
          inputFlechas.setAttribute("readonly", true);
          inputObs.setAttribute("readonly", true);
          btnEdit.textContent = "Editar";
          inputObs.rows = 1;
        } catch (error) { alert("Erro ao atualizar registo."); }
      }
    });
  });
}

// üîπ Exportar para Excel
exportBtn.addEventListener("click", async () => {
  let q;
  if (isTreinador) {
    q = query(collection(db, "treinos"), orderBy("data", "desc"));
  } else if (isAtleta) {
    q = query(collection(db, "treinos"), where("email", "==", currentUser.email), orderBy("data", "desc"));
  } else {
    alert("N√£o tens permiss√£o para exportar.");
    return;
  }

  const snapshot = await getDocs(q);

  const dados = snapshot.docs.map(docSnap => {
    const r = docSnap.data();
    return {
      Atleta: getNomeAtleta(r.email),
      Email: r.email,
      Data: r.data,
      Flechas: r.numFlechas,
      Observa√ß√µes: r.observacoes || ''
    };
  });

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Treinos");
  XLSX.writeFile(wb, "Registos_Treinos.xlsx");
});
</script>
