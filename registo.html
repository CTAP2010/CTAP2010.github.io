---
layout: default
title: Registo de Treino
---

<section class="container my-5">
  <h1 class="mb-4 text-center" style="color: var(--verde-escuro);">Registo de Treino</h1>

  <!-- Botão Login Google -->
  <div class="text-center mb-4">
    <button id="loginGoogle" class="btn btn-success btn-lg">Entrar com Google</button>
  </div>

  <!-- Formulário de registo de treino -->
  <form id="treinoForm" style="display:none; max-width: 600px; margin: auto;">
    <div class="mb-3">
      <label for="dataTreino" class="form-label">Data:</label>
      <input type="date" id="dataTreino" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="numFlechas" class="form-label">Número de flechas:</label>
      <input type="number" id="numFlechas" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="obsTreino" class="form-label">Observações:</label>
      <textarea id="obsTreino" class="form-control" rows="3"></textarea>
    </div>

    <button type="submit" class="btn btn-success">Registar Treino</button>
  </form>

  <!-- Tabela de treinos -->
  <div id="treinosContainer" class="mt-5" style="display:none;">
    <h2 class="mb-4 text-center" style="color: var(--verde-escuro);">Meus Treinos</h2>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Data</th>
          <th>Número de Flechas</th>
          <th>Observações</th>
          <th>Registado em</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="treinosTableBody"></tbody>
    </table>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { 
    getAuth, 
    GoogleAuthProvider, 
    signInWithPopup, 
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    where, 
    orderBy, 
    getDocs, 
    deleteDoc, 
    doc, 
    serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // ⚠️ Usa os mesmos dados que tens em login.html
	const firebaseConfig = {
	  apiKey: "AIzaSyDxTP9oTiAlDRpjGgC_hL06uzpYLrbzZd8",
	  authDomain: "ctap-registo.firebaseapp.com",
	  projectId: "ctap-registo",
	  storageBucket: "ctap-registo.firebasestorage.app",
	  messagingSenderId: "460997897512",
	  appId: "1:460997897512:web:841860bf674a5b1d19b41d"
	};


  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginButton = document.getElementById('loginGoogle');
  const treinoForm = document.getElementById('treinoForm');
  const treinosContainer = document.getElementById('treinosContainer');
  const treinosTableBody = document.getElementById('treinosTableBody');

  let currentUser = null;

  // Login Google
  loginButton.addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      currentUser = result.user;
      alert(`Bem-vindo, ${currentUser.displayName}!`);
      treinoForm.style.display = 'block';
      loginButton.style.display = 'none';
      carregarTreinos(currentUser.uid);
    } catch (error) {
      console.error("Erro Firebase:", error);
      alert("Erro Firebase: " + error.code + " - " + error.message);
    }
  });

  // Estado do utilizador (mantém sessão ativa)
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      treinoForm.style.display = 'block';
      loginButton.style.display = 'none';
      carregarTreinos(user.uid);
    } else {
      currentUser = null;
      treinoForm.style.display = 'none';
      loginButton.style.display = 'block';
      treinosContainer.style.display = 'none';
    }
  });

  // Registar treino
  treinoForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) {
      alert("Faz login antes de registar o treino.");
      return;
    }
    try {
      await addDoc(collection(db, "treinos"), {
        uid: currentUser.uid,
        nome: currentUser.displayName,
        email: currentUser.email,
        data: document.getElementById('dataTreino').value,
        flechas: parseInt(document.getElementById('numFlechas').value),
        observacoes: document.getElementById('obsTreino').value,
        timestamp: serverTimestamp()
      });
      alert("Treino registado com sucesso!");
      treinoForm.reset();
      carregarTreinos(currentUser.uid);
    } catch (error) {
      console.error(error);
      alert("Erro ao registar treino: " + error.message);
    }
  });

  // Carregar treinos do utilizador
  async function carregarTreinos(uid) {
    treinosTableBody.innerHTML = '';
    try {
      const q = query(
        collection(db, "treinos"),
        where("uid", "==", uid),
        orderBy("timestamp", "desc")
      );
      const snapshot = await getDocs(q);
      snapshot.forEach((docSnap) => {
        const treino = docSnap.data();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${treino.data}</td>
          <td>${treino.flechas}</td>
          <td>${treino.observacoes || ''}</td>
          <td>${treino.timestamp ? treino.timestamp.toDate().toLocaleString() : ''}</td>
          <td><button class="btn btn-sm btn-danger" onclick="eliminarTreino('${docSnap.id}', '${uid}')">Eliminar</button></td>
        `;
        treinosTableBody.appendChild(row);
      });
      treinosContainer.style.display = snapshot.size > 0 ? 'block' : 'none';
    } catch (error) {
      console.error(error);
      alert("Erro ao carregar treinos: " + error.message);
    }
  }

  // Eliminar treino
  window.eliminarTreino = async (docId, uid) => {
    if (confirm("Tens a certeza que queres eliminar este treino?")) {
      try {
        await deleteDoc(doc(db, "treinos", docId));
        alert("Treino eliminado com sucesso!");
        carregarTreinos(uid);
      } catch (error) {
        console.error(error);
        alert("Erro ao eliminar treino: " + error.message);
      }
    }
  };
</script>
